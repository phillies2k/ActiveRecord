/*!
 * ActiveRecord v1.3.0
 *
 * Copyright (c) 2011 Philipp Boes
 * https://github.com/phillies2k/ActiveRecord/
 * 
 * Published under the GPL License.
 *
 * Includes MD5 (Message-Digest Algorithm)
 * http://www.webtoolkit.info/
 *
 * Last-Modified: 07/03/11
 *
 */
if(!Object.prototype.watch){Object.prototype.watch=function(f,b){var c=this[f],d=c,a=function(){return d},e=function(g){c=d;return d=b.call(this,f,c,g)};if(delete this[f]){if(Object.defineProperty){Object.defineProperty(this,f,{get:a,set:e})}else{if(Object.prototype.__defineGetter__&&Object.prototype.__defineSetter__){Object.prototype.__defineGetter__.call(this,f,a);Object.prototype.__defineSetter__.call(this,f,e)}}}}}if(!Object.prototype.unwatch){Object.prototype.unwatch=function(b){var a=this[b];delete this[b];this[b]=a}}var ActiveRecord=function(a,b){if(!a||typeof a!="string"){throw new Error('ActiveRecord.init must have at least one argument, the storage name to access (e.g. $db("myStorage"))')}this.settings=ActiveRecord.extend(ActiveRecord.settings,b);var c=new ActiveRecord.DB(a);this.__defineGetter__("methods",ActiveRecord.method_names);this.__defineGetter__("db",function(){return c});return this};ActiveRecord.extend=function(){var f=arguments[0],a=arguments.length,b=1,h,d,c,e;for(;b<a;b++){h=arguments[b];for(e in h){d=h.__lookupGetter__(e);c=h.__lookupSetter__(e);if(d||c){if(d){f.__defineGetter__(e,d)}if(c){f.__defineSetter__(e,c)}}else{if(typeof f[e]=="undefined"){f[e]=h[e]}}}}return f};ActiveRecord.extend(ActiveRecord,{VERSION:"1.3.0",BELONGS_TO:1,BELONGS_TO_AND_HAS_MANY:2,HAS_ONE:3,HAS_MANY:4,SORT_ASC:"asc",SORT_DESC:"desc",SYNC_ONE_WAY:0,SYNC_TWO_WAY:1,IGNORED_PROPS:{__guid__:true,__proto__:true,prototype:true,watch:true,unwatch:true},MAGIC_PROPS:{__belongsTo:true,__belongsToAndHasMany:true,__hasMany:true,__hasOne:true},settings:{syncUrl:null,syncMode:0,sync:false,method:"GET",user:null,pass:null,params:null},serialize:function(g){var f=encodeURIComponent,a=[],d,c=function(h,e){e=typeof e=="function"?e():e;a[a.length]=f(h)+"="+f(e)},b=function(e,h){if(typeof h=="object"){for(var j in h){b(e+"["+j+"]",h[j])}}else{c(e,h)}};for(d in g){b(d,g[d])}return a.join("&").replace(/%20/g,"+")},obj_hash:function(a){return MD5(a.__guid__.toString())},method_names:function(d){var c=d&&d.__proto__||this.__proto__,b=[],a;for(a in c){if(a==="__proto__"||a==="constructor"||c[a].__lookupGetter__(a)||c[a].__lookupSetter__(a)){continue}else{b.push(a)}}return b}});ActiveRecord.prototype={constructor:ActiveRecord,getUUIDFromObject:function(a){return ActiveRecord.obj_hash(a)},get:function(a){return this.db.get(a)},getAll:function(){return this.db.getAll()},has:function(a){return this.db.has(a)},clear:function(a){return this.db.clear(a)},clearAll:function(){var b,a=this.getAll();for(b in a){this.db.clear(b)}return this},destroy:function(a){this.db.destroy(a);return this},destroyAll:function(){var b,a=this.getAll();for(b in a){this.db.destroy(b)}return this},create:function(b,a){return this.db.create(b,a)},persist:function(a){return this.db.persist(a)},persistAll:function(){return this.db.persistAll()}};ActiveRecord.DB=function(a){this.storage=a;this.records={};return this};ActiveRecord.DB.prototype={constructor:ActiveRecord.DB,clear:function(b){var a=this.get(b);a.removedObjects.clear();a.addedObjects.clear();localStorage.setItem(this.storage+"."+b,JSON.stringify([a.getSchemata(),a.getRelations(),{}],function(c,d){return this[c] instanceof Function?this[c].toString():d}));this.records[b]=a;return a},destroy:function(a){delete this.records[a];localStorage.removeItem(this.storage+"."+a)},has:function(a){return !!localStorage.getItem(this.storage+"."+a)},create:function(c,b){if(this.has(c)){throw new Error("a model of that type already exists in this storage.")}var a=new ActiveRecord.Model(c,b,this);this.records[c]=a;return this.records[c]},getAll:function(){var d,a,b={},c;for(d in localStorage){if(d.indexOf(this.storage+".")===0){c=d.substr(this.storage.length+1);b[c]=this.get(c)}}return b},get:function(type){if(this.has(type)){if(!this.records[type]){try{var raw=JSON.parse(localStorage.getItem(this.storage+"."+type),function(key,val){if(typeof val=="string"&&/^function\s*\(/.test(val)){eval("val = "+val)}return val}),model=new ActiveRecord.Model(type,raw[0],this),uuid;model.relations=raw[1];for(uuid in raw[2]){model.add(raw[2][uuid])}this.records[type]=model}catch(e){console.log(e)}}return this.records[type]}return false},persist:function(a){try{var d=a.addedObjects.toObject(),h=a.removedObjects.toObject(),b=this.storage+"."+a.type,c,g=localStorage.getItem(b),j;g=g?JSON.parse(g):[a.getSchemata(),a.getRelations(),{}];for(c in d){if(/^[a-z0-9]{32}$/.test(c)){for(j in d[c]){if(j in a.ignoredProperties){delete d[c][j]}}g[2][c]=d[c]}}for(c in h){if(g[2][c]){delete g[2][c]}}localStorage.setItem(b,JSON.stringify(g,function(e,k){return k instanceof Function?k.toString():k}))}catch(f){console.log(f)}finally{return true}},persistAll:function(){for(var a in this.records){this.persist(this.records[a])}}};ActiveRecord.Model=function(c,b,a){if(typeof a!="object"&&!a instanceof ActiveRecord.DB){throw new Error("db must be an instance of ActiveRecord.DB. instance of "+(typeof a)+"given.")}if(typeof c!=="string"){throw new Error("type must be of type string.")}if(typeof b!="object"){throw new Error("invalid model schemata given.")}this.type=c.toLowerCase();this.db=a;for(var d in b){if(d in ActiveRecord.IGNORED_PROPS){continue}else{if(d in ActiveRecord.MAGIC_PROPS){this.relations[d]=b[d].split(/\s*,\s*/)}else{this.schemata[d]=b[d]}}}this.addedObjects=new ActiveRecord.Storage;this.removedObjects=new ActiveRecord.Storage;return this};ActiveRecord.Model.prototype={constructor:ActiveRecord.Model,db:null,validation:true,addedObjects:null,removedObjects:null,schemata:{},relations:{},type:"",dirty:false,findByUUID:function(a){if(typeof this.addedObjects.storage[a]!="undefined"){return new ActiveRecord.Set(this.addedObjects.storage[a])}return false},findOne:function(){var a=this.findAll(),b;for(b in a){break}return a[b]},findOneBy:function(c,a,b){return this.findAllBy(c,a,b,0,1)},findAllBy:function(prop,val,op,offset,limit){offset=offset||0;op=op||"equals";var records=this.addedObjects.storage,results={length:0},self=this,uuid,record,modelType,add_record=function(){if(results.length>=offset&&(!limit||limit&&results.length<limit)){results[uuid]=record;++results.length}},auto_wire_relations=function(){var res={},rel,i,mtype,model,curr;for(rel in self.relations){switch(rel){case"__belongsTo":case"__hasOne":case"__belongsToAndHasMany":case"__hasMany":for(i=0;i<self.relations[rel].length;i++){mtype=self.relations[rel][i].toLowerCase();if(self.db.has(mtype)){if(res[mtype]){throw new Error("a property with that name already exists")}res[mtype]={};model=self.db.get(mtype);curr=model.findAllBy(prop,val,op,offset,limit);if(curr.length){res[mtype]=curr}}}break}}return res};if(prop.indexOf(".")>0){var b=prop.split(".");modelType=b[0];prop=b[1];var props=auto_wire_relations()}for(uuid in records){record=records[uuid];if(modelType&&modelType.length){}else{if(typeof record[prop]!="undefined"){switch(op){case"equals":if(record[prop]==val){add_record()}break;case"==":case"!=":case">":case"<":case"<=":case">=":eval("var isTrue = record[prop] "+op+" val ? true : false;");if(isTrue===true){add_record()}break;case"in":switch(typeof record[prop]){case"object":if(val in record[prop]){add_record()}break;case"string":case"number":if(record[prop].toString().indexOf(val)>-1){add_record()}break;default:throw new Error('cannot use "in" operator here.')}break;default:throw new Error("invalid operator.")}}}}return new ActiveRecord.Set(results)},findAll:function(){return new ActiveRecord.Set(this.addedObjects.storage)},remove:function(a){if(!this.removedObjects.has(a)){if(this.addedObjects.has(a)){this.addedObjects.detach(a)}this.removedObjects.attach(a)}return this},removeByUUID:function(a){if(!this.removedObjects.storage[a]){if(this.addedObjects.storage[a]){delete this.addedObjects.storage[a]}this.removedObjects.storage[a]={}}return this},update:function(a){if(this.addedObjects.has(a)){this.addedObjects.storage[ActiveRecord.obj_hash(a)]=a}return this},getSchemata:function(){return this.schemata},getRelations:function(a){return a&&this.relations[a]?this.relations[a]:this.relations},replace:function(a,b){if(this.addedObjects.has(a)){this.addedObjects.detach(a);this.addedObjects.attach(b)}return this},replaceByUUID:function(a,b){if(typeof this.addedObjects.storage[a]!="undefined"){this.addedObjects.storage[a]=b}return this},add:function(a){if(!this.validation||(this.validation===true&&(a=this.validate(a)))){if(!a.hasOwnProperty("__guid__")){a.__defineGetter__("__guid__",(function(){var b=0;return function(){var c=(new Date()).getTime()+"_"+(++b);this.__proto__={__proto__:this.__proto__,get __guid__function(){return c}};return c}})())}if(this.removedObjects.has(a)){this.removedObjects.detach(a)}this.addedObjects.attach(a)}return this},clear:function(){return this.db.clear(this.type)},destroy:function(){this.db.destroy(this.type);return this},persist:function(){this.db.persist(this);return this},validate:function(b){var e,d=[],c,a;for(e in b){if(e in ActiveRecord.IGNORED_PROPS||/^\d+$/.test(e)){continue}if(typeof this.schemata[e]=="undefined"){d.push('undefined model property "'+e+'".');continue}a=this.schemata[e].type;switch(a){case"datetime":c=/^\d{2,4}(\.|\/)\d{2}(\.|\/)\d{2,4} \d{2}\:\d{2}(\:\d{2})?$/;case"time":c=c||/^\d{2}\:\d{2}(\:\d{2})?$/;case"date":c=c||/^\d{2,4}(\.|\/)\d{2}(\.|\/)\d{2,4}$/;a="string";if(typeof b[e]!=a){d.push('model property "'+e+'" must be of type '+a+", "+typeof b[e]+" given.");continue}break;case"string":case"number":case"boolean":case"object":if(typeof b[e]!=a){d.push('model property "'+e+'" must be of type '+a+", "+typeof b[e]+" given.");continue}break}if(typeof this.schemata[e].sanitize=="function"){b[e]=this.schemata[e].sanitize(b[e])}if(typeof this.schemata[e].validate=="function"&&this.schemata[e].validate.apply(b[e])===false){d.push('value of "'+e+'" failed validation.');continue}}if(d.length>0){throw new Error("\n\t- "+d.join("\n\t- "))}return b}};ActiveRecord.Set=function(a){this.length=0;var c,b;for(c in a){if(c in ActiveRecord.IGNORED_PROPS){continue}b=a[c];if(!b.hasOwnProperty("__guid__")){b.__defineGetter__("__guid__",(function(){var d=0;return function(){var e=(new Date()).getTime()+(++d);this.__proto__={__proto__:this.__proto__,get __guid__function(){return e}};return e}})())}this[(++this.length)-1]=a[c]}return this};ActiveRecord.Set.prototype={constructor:ActiveRecord.Set,get:function(a){return !!this[a]&&this[a]},each:function(b){var c=Array.prototype.slice.call(this,0),a=c.length;for(;i<a;i++){if(typeof b=="function"){b.call(c[i],i,c)}}return this},sort:function(b,a){a=a||b;return Array.prototype.slice.call(this,0).sort(function(d,c){return b&&typeof d[b]!="undefined"?(a=="ASC"?d[b]-c[b]:c[b]-d[b]):(a=="ASC"?d.__guid__-c.__guid__:c.__guid__-d.__guid__)})}};ActiveRecord.Storage=function(){this.length=0;return this};ActiveRecord.Storage.prototype={constructor:ActiveRecord.Storage,has:function(a){return !!this[ActiveRecord.obj_hash(a)]},attach:function(a){if(!this.has(a)){this[ActiveRecord.obj_hash(a)]=a;++this.length}},detach:function(a){if(this.has(a)){delete this[ActiveRecord.obj_hash(a)];--this.length}},toObject:function(){var a={},b;for(b in this){if(/^[a-z0-9]{32}$/.test(b)){a[b]=this[b]}}return a}};