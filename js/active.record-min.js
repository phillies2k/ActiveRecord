/*!
 * ActiveRecord v1.2
 *
 * Copyright (c) 2011 Philipp Boes
 * https://github.com/phillies2k/ActiveRecord/
 * 
 * Licensed under the GPL License.
 *
 * Includes MD5 (Message-Digest Algorithm)
 * http://www.webtoolkit.info/
 *
 */
var MD5=function(s){function L(b,a){return(b<<a)|(b>>>(32-a))}function K(k,b){var F,a,d,x,c;d=(k&2147483648);x=(b&2147483648);F=(k&1073741824);a=(b&1073741824);c=(k&1073741823)+(b&1073741823);if(F&a){return(c^2147483648^d^x)}if(F|a){if(c&1073741824){return(c^3221225472^d^x)}else{return(c^1073741824^d^x)}}else{return(c^d^x)}}function r(a,c,b){return(a&c)|((~a)&b)}function q(a,c,b){return(a&b)|(c&(~b))}function p(a,c,b){return(a^c^b)}function n(a,c,b){return(c^(a|(~b)))}function u(G,F,aa,Z,k,H,I){G=K(G,K(K(r(F,aa,Z),k),I));return K(L(G,H),F)}function f(G,F,aa,Z,k,H,I){G=K(G,K(K(q(F,aa,Z),k),I));return K(L(G,H),F)}function D(G,F,aa,Z,k,H,I){G=K(G,K(K(p(F,aa,Z),k),I));return K(L(G,H),F)}function t(G,F,aa,Z,k,H,I){G=K(G,K(K(n(F,aa,Z),k),I));return K(L(G,H),F)}function e(k){var G;var d=k.length;var c=d+8;var b=(c-(c%64))/64;var F=(b+1)*16;var H=Array(F-1);var a=0;var x=0;while(x<d){G=(x-(x%4))/4;a=(x%4)*8;H[G]=(H[G]|(k.charCodeAt(x)<<a));x++}G=(x-(x%4))/4;a=(x%4)*8;H[G]=H[G]|(128<<a);H[F-2]=d<<3;H[F-1]=d>>>29;return H}function B(c){var b="",d="",k,a;for(a=0;a<=3;a++){k=(c>>>(a*8))&255;d="0"+k.toString(16);b=b+d.substr(d.length-2,2)}return b}function J(b){b=b.replace(/\r\n/g,"\n");var a="";for(var k=0;k<b.length;k++){var d=b.charCodeAt(k);if(d<128){a+=String.fromCharCode(d)}else{if((d>127)&&(d<2048)){a+=String.fromCharCode((d>>6)|192);a+=String.fromCharCode((d&63)|128)}else{a+=String.fromCharCode((d>>12)|224);a+=String.fromCharCode(((d>>6)&63)|128);a+=String.fromCharCode((d&63)|128)}}}return a}var C=Array();var P,h,E,v,g,Y,X,W,V;var S=7,Q=12,N=17,M=22;var A=5,z=9,y=14,w=20;var o=4,m=11,l=16,j=23;var U=6,T=10,R=15,O=21;s=J(s);C=e(s);Y=1732584193;X=4023233417;W=2562383102;V=271733878;for(P=0;P<C.length;P+=16){h=Y;E=X;v=W;g=V;Y=u(Y,X,W,V,C[P+0],S,3614090360);V=u(V,Y,X,W,C[P+1],Q,3905402710);W=u(W,V,Y,X,C[P+2],N,606105819);X=u(X,W,V,Y,C[P+3],M,3250441966);Y=u(Y,X,W,V,C[P+4],S,4118548399);V=u(V,Y,X,W,C[P+5],Q,1200080426);W=u(W,V,Y,X,C[P+6],N,2821735955);X=u(X,W,V,Y,C[P+7],M,4249261313);Y=u(Y,X,W,V,C[P+8],S,1770035416);V=u(V,Y,X,W,C[P+9],Q,2336552879);W=u(W,V,Y,X,C[P+10],N,4294925233);X=u(X,W,V,Y,C[P+11],M,2304563134);Y=u(Y,X,W,V,C[P+12],S,1804603682);V=u(V,Y,X,W,C[P+13],Q,4254626195);W=u(W,V,Y,X,C[P+14],N,2792965006);X=u(X,W,V,Y,C[P+15],M,1236535329);Y=f(Y,X,W,V,C[P+1],A,4129170786);V=f(V,Y,X,W,C[P+6],z,3225465664);W=f(W,V,Y,X,C[P+11],y,643717713);X=f(X,W,V,Y,C[P+0],w,3921069994);Y=f(Y,X,W,V,C[P+5],A,3593408605);V=f(V,Y,X,W,C[P+10],z,38016083);W=f(W,V,Y,X,C[P+15],y,3634488961);X=f(X,W,V,Y,C[P+4],w,3889429448);Y=f(Y,X,W,V,C[P+9],A,568446438);V=f(V,Y,X,W,C[P+14],z,3275163606);W=f(W,V,Y,X,C[P+3],y,4107603335);X=f(X,W,V,Y,C[P+8],w,1163531501);Y=f(Y,X,W,V,C[P+13],A,2850285829);V=f(V,Y,X,W,C[P+2],z,4243563512);W=f(W,V,Y,X,C[P+7],y,1735328473);X=f(X,W,V,Y,C[P+12],w,2368359562);Y=D(Y,X,W,V,C[P+5],o,4294588738);V=D(V,Y,X,W,C[P+8],m,2272392833);W=D(W,V,Y,X,C[P+11],l,1839030562);X=D(X,W,V,Y,C[P+14],j,4259657740);Y=D(Y,X,W,V,C[P+1],o,2763975236);V=D(V,Y,X,W,C[P+4],m,1272893353);W=D(W,V,Y,X,C[P+7],l,4139469664);X=D(X,W,V,Y,C[P+10],j,3200236656);Y=D(Y,X,W,V,C[P+13],o,681279174);V=D(V,Y,X,W,C[P+0],m,3936430074);W=D(W,V,Y,X,C[P+3],l,3572445317);X=D(X,W,V,Y,C[P+6],j,76029189);Y=D(Y,X,W,V,C[P+9],o,3654602809);V=D(V,Y,X,W,C[P+12],m,3873151461);W=D(W,V,Y,X,C[P+15],l,530742520);X=D(X,W,V,Y,C[P+2],j,3299628645);Y=t(Y,X,W,V,C[P+0],U,4096336452);V=t(V,Y,X,W,C[P+7],T,1126891415);W=t(W,V,Y,X,C[P+14],R,2878612391);X=t(X,W,V,Y,C[P+5],O,4237533241);Y=t(Y,X,W,V,C[P+12],U,1700485571);V=t(V,Y,X,W,C[P+3],T,2399980690);W=t(W,V,Y,X,C[P+10],R,4293915773);X=t(X,W,V,Y,C[P+1],O,2240044497);Y=t(Y,X,W,V,C[P+8],U,1873313359);V=t(V,Y,X,W,C[P+15],T,4264355552);W=t(W,V,Y,X,C[P+6],R,2734768916);X=t(X,W,V,Y,C[P+13],O,1309151649);Y=t(Y,X,W,V,C[P+4],U,4149444226);V=t(V,Y,X,W,C[P+11],T,3174756917);W=t(W,V,Y,X,C[P+2],R,718787259);X=t(X,W,V,Y,C[P+9],O,3951481745);Y=K(Y,h);X=K(X,E);W=K(W,v);V=K(V,g)}var i=B(Y)+B(X)+B(W)+B(V);return i.toLowerCase()}
(function(){var H={};if(!Object.prototype.watch){Object.prototype.watch=function(prop,handler){var oldval=this[prop],newval=oldval,getter=function(){return newval},setter=function(val){oldval=newval;return newval=handler.call(this,prop,oldval,val)};if(delete this[prop]){if(Object.defineProperty){Object.defineProperty(this,prop,{get:getter,set:setter})}else{if(Object.prototype.__defineGetter__&&Object.prototype.__defineSetter__){Object.prototype.__defineGetter__.call(this,prop,getter);Object.prototype.__defineSetter__.call(this,prop,setter)}}}}}if(!Object.prototype.unwatch){Object.prototype.unwatch=function(prop){var val=this[prop];delete this[prop];this[prop]=val}}Object.prototype.__defineGetter__("__uuid__",(function(){H.gid=0;return function(){var id=H.gid++;this.__proto__={__proto__:this.__proto__,get __uuid__function(){return id},set __uuid__function(){}};return id}})());Object.prototype.toString=function(){return"[object #"+this.__uuid__+"]"};function serialize(obj){var s=[],p,add=function(k,v){v=typeof v=="function"?v():v;s[s.length]=encodeURIComponent(k)+"="+encodeURIComponent(v)},buildParams=function(prefix,o){if(typeof o=="object"){for(var n in o){buildParams(prefix+"["+n+"]",o[n])}}else{add(prefix,o)}};for(p in obj){buildParams(p,obj[p])}return s.join("&").replace(/%20/g,"+")}function extend(){var t=arguments[0]||this,len=arguments.length,i=1,src,g,s,p;for(;i<len;i++){src=arguments[i];for(p in src){g=src.__lookupGetter__(p);s=src.__lookupSetter__(p);if(g||s){if(g){t.__defineGetter__(p,g)}if(s){t.__defineSetter__(p,s)}}else{t[p]=src[p]}}}return t}function obj_hash(obj){return MD5(serialize(obj))}window.$storage=window.localStorage=localStorage;window.ActiveRecord=window.$db=ActiveRecord={Version:"1.1.0",SORT_ASC:"asc",SORT_DESC:"desc",BELONGS_TO:1,BELONGS_TO_AND_HAS_MANY:2,HAS_MANY:3,HAS_ONE:4,SYNC_ONE_WAY:0,SYNC_TWO_WAY:1,settings:{syncUrl:null,syncMode:0,sync:false,method:"GET",user:null,pass:null,params:null},Storage:function(){return new ActiveRecord.Storage.fn.init()},DB:function(db){return new ActiveRecord.DB.fn.init(db)},Model:function(type,schemata,db){return new ActiveRecord.Model.fn.init(type,schemata,db)},init:function(db,options){options=options||{};options=extend({},this.settings,options);return new ActiveRecord.fn.init(db,options)}};ActiveRecord.Storage.fn=ActiveRecord.Storage.prototype={constructor:ActiveRecord.Storage,storage:null,init:function(){this.storage={}},attach:function(obj){if(!this.has(obj)){this.storage[obj_hash(obj)]=obj}},detach:function(obj){if(this.has(obj)){delete this.storage[obj_hash(obj)]}},has:function(obj){return !!this.storage[obj_hash(obj)]},toObject:function(){var obj=this.storage;delete obj.__uuid__;delete obj.__proto__.__uuid__;return obj}};ActiveRecord.Storage.fn.init.prototype=ActiveRecord.Storage.fn;ActiveRecord.fn=ActiveRecord.prototype={constructor:ActiveRecord,settings:null,activeObjects:0,init:function(db,options){this.settings=options;this.db=new ActiveRecord.DB(db);var self=this;H.watch("gid",function(prop,oldVal,newVal){self.activeObjects=newVal;return newVal});return this},getUUIDFromObject:function(obj){return obj_hash(obj)},get:function(type){return this.db.get(type)},getAll:function(){return this.db.getAll()},has:function(type){return this.db.has(type)},clear:function(type){return this.db.clear(type)},destroy:function(type){return this.db.destroy(type)},create:function(type,schemata){return this.db.create(type,schemata)},persist:function(model){return this.db.persist(model)},persistAll:function(){return this.db.persistAll()},sync:function(mode){if(this.synchronizing){return}mode=mode||this.settings.syncMode;try{this.synchronizing=true;var options={url:this.settings.syncUrl,method:this.settings.method.toUpperCase(),contentType:this.settings.method=="post"?this.settings.contentType||"application/x-www-form-urlencoded":null,encoding:this.settings.encoding||null,params:this.settings.params||{}};var xhr=new XMLHttpRequest();xhr.open(options.method,options.url,true);var name,headers={"X-Requested-With":"XMLHttpRequest","X-ActiveRecord-Version":ActiveRecord.Version,Accept:"text/javascript, text/html, application/xml, text/xml, */*"};if(options.method=="POST"){headers["Content-Type"]=options.contentType+(options.encoding?"; charset="+options.encoding:"")}for(name in headers){xhr.setRequestHeader(name,headers[name])}xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.getResponseHeader("Content-Type").indexOf("application/json")===0){eval("xhr.responseJSON = "+xhr.responseText)}}};options.params.data={};var type,repo,all=this.getAll();for(type in all){repo=all[type];options.params.data[type]=[repo.getSchemata(),repo.getRelations(),this.settings.syncRecords?repo.findAll():null]}xhr.send(options.method=="POST"?serialize(options.params):null)}catch(e){throw new Error(e)}finally{this.synchronizing=false}}};ActiveRecord.fn.init.prototype=ActiveRecord.fn;ActiveRecord.DB.fn=ActiveRecord.DB.prototype={constructor:ActiveRecord.DB,repositories:null,storage:"",init:function(db){this.repositories={};this.storage=db;return this},clear:function(type){var model=this.get(type);this.repositories[type].removedObjects.storage=this.repositories[type].addedObjects.storage={};$storage.setItem(this.storage+"."+type,JSON.stringify([model.getSchemata(),model.getRelations(),{}]))},destroy:function(type){delete this.repositories[type];$storage.removeItem(this.storage+"."+type)},has:function(type){return !!$storage.getItem(this.storage+"."+type)},create:function(type,schemata){if(this.has(type)){throw new Error("a model of that type already exists in this storage.")}var model=new ActiveRecord.Model(type,schemata,this);this.repositories[type]=model;return this.repositories[type]},getAll:function(){var p,raw,results={},type;for(p in $storage){if(p.indexOf(this.storage+".")===0){type=p.substr(this.storage.length+1);results[type]=this.get(type)}}return results},get:function(type){if(this.has(type)){if(!this.repositories[type]){var raw=JSON.parse($storage.getItem(this.storage+"."+type)),model=new ActiveRecord.Model(type,raw[0],this),uuid;model.relations=raw[1];for(uuid in raw[2]){model.add(raw[2][uuid])}this.repositories[type]=model}return this.repositories[type]}return false},persist:function(model){var added=model.addedObjects.toObject(),removed=model.removedObjects.toObject(),repo=this.storage+"."+model.type,uuid,dump=$storage.getItem(repo),n;dump=dump?JSON.parse(dump):[model.getSchemata(),model.getRelations(),{}];for(uuid in added){for(n in added[uuid]){if(n in model.ignoredProperties){delete added[uuid][n]}}dump[2][uuid]=added[uuid]}for(uuid in removed){if(dump[2][uuid]){delete dump[2][uuid]}}$storage.setItem(repo,JSON.stringify(dump));return true},persistAll:function(){for(var type in this.repositories){this.persist(this.repositories[type])}}};ActiveRecord.DB.fn.init.prototype=ActiveRecord.DB.fn;ActiveRecord.Model.fn=ActiveRecord.Model.prototype={constructor:ActiveRecord.Model,ignoredProperties:{__uuid__:true},magicProperties:{__belongsTo:true,__belongsToAndHasMany:true,__hasMany:true,__hasOne:true},db:null,validation:true,addedObjects:null,removedObjects:null,schemata:{},relations:{},type:false,init:function(type,schemata,db){if(typeof db!="object"&&!db instanceof ActiveRecord.DB){throw new Error("db must be an instance of ActiveRecord.DB. instance of "+(typeof db)+"given.")}if(typeof type!=="string"){throw new Error("type must be of type string.")}if(typeof schemata!="object"){throw new Error("invalid model schemata given.")}this.type=type.toLowerCase();this.db=db;for(var prop in schemata){if(prop in this.ignoredProperties){continue}else{if(prop in this.magicProperties){this.relations[prop]=schemata[prop].split(/\s*,\s*/);continue}}this.schemata[prop]=schemata[prop]}this.addedObjects=new ActiveRecord.Storage;this.removedObjects=new ActiveRecord.Storage;return this},findByUUID:function(uuid){if(typeof this.addedObjects.storage[uuid]!="undefined"){return this.addedObjects.storage[uuid]}return false},findOne:function(){var all=this.findAll(),p;for(p in all){break}return all[p]},findOneBy:function(prop,val,op){return this.findAllBy(prop,val,op,0,1)},findAllBy:function(prop,val,op,offset,limit){offset=offset||0;op=op||"equals";var records=this.addedObjects.storage,uuid,record,results={length:0},modelType,self=this,add_record=function(){if(results.length>=offset&&(!limit||limit&&results.length<limit)){results[uuid]=record;++results.length}},auto_wire_relations=function(){var rel,i,mtype,model,res={},curr;for(rel in self.relations){switch(rel){case"__belongsTo":case"__hasOne":case"__belongsToAndHasMany":case"__hasMany":for(i=0;i<self.relations[rel].length;i++){mtype=self.relations[rel][i].toLowerCase();if(self.db.has(mtype)){if(res[mtype]){throw new Error("a property with that name already exists")}res[mtype]={};model=self.db.get(mtype);curr=model.findAllBy(prop,val,op,offset,limit);if(curr.length){res[mtype]=curr}}}break}}return res};if(prop.indexOf(".")>0){var b=prop.split(".");modelType=b[0];prop=b[1];var props=auto_wire_relations()}for(uuid in records){record=records[uuid];if(modelType&&modelType.length){}else{if(typeof record[prop]!="undefined"){switch(op){case"equals":if(record[prop]==val){add_record()}break;case"==":case"!=":case">":case"<":case"<=":case">=":eval("var isTrue = record[prop] "+op+" val ? true : false;");if(isTrue===true){add_record()}break;case"in":switch(typeof record[prop]){case"object":if(val in record[prop]){add_record()}break;case"string":case"number":if(record[prop].toString().indexOf(val)>-1){add_record()}break;default:throw new Error('cannot use "in" operator here.')}break;default:throw new Error("invalid operator.")}}}}return results},findAll:function(){return this.addedObjects.storage},remove:function(obj){if(!this.removedObjects.has(obj)){if(this.addedObjects.has(obj)){this.addedObjects.detach(obj)}this.removedObjects.attach(obj)}return this},removeByUUID:function(uuid){if(!this.removedObjects.storage[uuid]){if(this.addedObjects.storage[uuid]){delete this.addedObjects.storage[uuid]}this.removedObjects.storage[uuid]={}}return this},update:function(obj){if(this.addedObjects.has(obj)){this.addedObjects.storage[obj_hash(obj)]=obj}return this},getSchemata:function(){return this.schemata},getRelations:function(filter){return filter&&this.relations[filter]?this.relations[filter]:this.relations},replace:function(oldObj,newObj){if(this.addedObjects.has(oldObj)){this.addedObjects.detach(oldObj);this.addedObjects.attach(newObj)}return this},replaceByUUID:function(uuid,obj){if(typeof this.addedObjects.storage[uuid]!="undefined"){this.addedObjects.storage[uuid]=obj}return this},add:function(obj){if(!this.validation||(this.validation===true&&this.validate(obj))){if(this.removedObjects.has(obj)){this.removedObjects.detach(obj)}this.addedObjects.attach(obj)}return this},clear:function(){this.db.clear(this.type);return this},destroy:function(){this.db.destroy(this.type);return this},persist:function(){this.db.persist(this);return this},validate:function(obj){var prop,validationErrors=[];for(prop in obj){if(prop in this.ignoredProperties){continue}if(typeof this.schemata[prop]=="undefined"){validationErrors.push('undefined model property "'+prop+'".');continue}switch(this.schemata[prop].type){case"datetime":if(typeof obj[prop]!="string"||!/^\d{2,4}(\.|\/)\d{2}(\.|\/)\d{2,4} \d{2}\:\d{2}(\:\d{2})?$/.test(obj[prop])){validationErrors.push('model property "'+prop+'" must be of type '+this.schemata[prop].type+", "+typeof obj[prop]+" given.");continue}break;case"time":if(typeof obj[prop]!="string"||!/^\d{2}\:\d{2}(\:\d{2})?$/.test(obj[prop])){validationErrors.push('model property "'+prop+'" must be of type '+this.schemata[prop].type+", "+typeof obj[prop]+" given.");continue}break;case"date":if(typeof obj[prop]!="string"||!/^\d{2,4}(\.|\/)\d{2}(\.|\/)\d{2,4}$/.test(obj[prop])){validationErrors.push('model property "'+prop+'" must be of type '+this.schemata[prop].type+", "+typeof obj[prop]+" given.");continue}break;case"string":case"number":case"boolean":case"object":if(typeof obj[prop]!=this.schemata[prop].type){validationErrors.push('model property "'+prop+'" must be of type '+this.schemata[prop].type+", "+typeof obj[prop]+" given.");continue}break}if(typeof this.schemata[prop].validate=="function"&&this.schemata[prop].validate.apply(obj[prop])===false){validationErrors.push('value of "'+prop+'" failed validation.');continue}}if(validationErrors.length>0){throw new Error("\n\t- "+validationErrors.join("\n\t- "))}return true}};ActiveRecord.Model.fn.init.prototype=ActiveRecord.Model.fn})();